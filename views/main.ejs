<!DOCTYPE html>
<html lang="en">
<head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+ph61jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js" integrity="sha384-SR1sx49pcuLnqZUnnPwx6FCym0wLsk5JZuNx2bPPENzswTNFaQU1RDvt3wT4gWFG" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.min.js" integrity="sha384-j0CNLUeiqtyaRmlzUHCPZ+Gy5fQu0dQ6eZ/xAww941Ai1SxSY+0EQqNXNE6DZiVc" crossorigin="anonymous"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link rel="stylesheet" type="text/css" href="css/style.css" />

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
    
    const API_KEY = "AIzaSyBHaqk2GKbbWoQW7exIXfWGsr1sndPDWf4";
    const CLIENT_ID = "713860404856-c59se7k5c66mr32cpufi1l7thfmmompn.apps.googleusercontent.com";
    const MAX_MESSAGES = 10;

    function authenticate() {
        return gapi.auth2.getAuthInstance()
            .signIn({scope: "https://mail.google.com/ https://www.googleapis.com/auth/gmail.compose https://www.googleapis.com/auth/gmail.modify https://www.googleapis.com/auth/gmail.readonly"})
            .then(function() { console.log("Sign-in successful"); },
                function(err) { console.error("Error signing in", err); });
    }

    function loadClient() {
        //const keys = getKeys();
        gapi.client.setApiKey(API_KEY);
        return gapi.client.load("https://gmail.googleapis.com/$discovery/rest?version=v1")
            .then(function() { console.log("GAPI client loaded for API"); },
                function(err) { console.error("Error loading GAPI client for API", err); });
    }

    function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut();    
        console.log("Signed out");
    }

    function getProfile() {

        return gapi.client.gmail.users.getProfile({"userId" : 'me'})
            .then(function(response) {                
                console.log(response.result);
            },
            function(err) { console.error("Execute error", err); });
    }

    function fetchMessages(){
            
        return gapi.client.gmail.users.messages.list({"userId" : "me"})
        .then(function(response) {
            let messages = response.result["messages"];
            console.log(messages);
            putMessages(messages);
            
            
        });
    }

    function putMessages(messages){
        
        for(let i = 0; i < MAX_MESSAGES; i++){
            const messageId = (messages[i]["id"]);
            putMessage(messageId);
            
            
        }
    }

    function putMessage(messageId){
        return gapi.client.gmail.users.messages.get({"userId" : 'me', "id" : messageId})
            .then(function(response){
                console.log(response.result);
                const snippet = response.result["snippet"];  
                let from = "", subject = "";
                response.result["payload"]["headers"].forEach(header => {
                    if(header["name"] == "From"){
                        from = header["value"];
                    }
                    else if(header["name"] == "Subject"){
                        subject = header["value"];
                    }
                });
                console.log(response.result);       
                document.getElementById('messages').innerHTML += 
                '<li onclick="alert(1);" class="message list-group-item list-group-item-action  text-white">' + 
                    
                    '<div class="overflow">' +  from + '</div> ' + 
                    '<div class="overflow">' +  subject + '</div> '  +
                    '<div class="overflow">' +  snippet + '</div> '
                '</li>';
            })
            
    }

    function execute() {

    // gapi.client.gmail.users.getProfile({"userId" : 'me'})
        return gapi.client.gmail.users.messages.get({"userId" : 'me', "id" : "17d51b980a220422"})
            .then(function(response) {
                //js = JSON.parse(response.result)
                // Handle the results here (response.result has the parsed body).
                body = response.result;
                parts = body["payload"]["parts"]
                parts.forEach(part => {
                if(part["mimeType"] == "text/plain"){
                    console.log(atob(part["body"]["data"].replace(/-/g, '+').replace(/_/g, '/')))
                }
                });
                
                console.log(body);
            },
            function(err) { console.error("Execute error", err); });
    }
    gapi.load("client:auth2", function() {
        gapi.auth2.init({"client_id" : CLIENT_ID});
    });
    
    </script>
   
</head>
<body onload="authenticate().then(loadClient).then(fetchMessages)">
    
    <div class="container-fluid bg-dark">
        <h2 class="header center text-white">Mail Box</h2>
        
    </div>
    <!-- s -->

    <div class="messages-div bg-dark">
        <ol class="messages list-group " id="messages">

        </ol>
    </div>
    

    <script>
        
    </script>
</body>
</html>